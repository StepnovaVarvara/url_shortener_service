# Url shortener service

### Микросервис, предназначенный для сокращения длинных URL-адресов. 
#### Пользователи могут использовать его, чтобы превратить длинные ссылки в короткие, что удобно для публикации в социальных сетях. Сервис поддерживает кэширование, многопоточность, работу с БД Postgres и Redis, а также взаимодействие через REST API. Он использует локальный кэш для повышения эффективности и планировщик для удаления старых ссылок.

### Инструкция по запуску проекта - последовательность команд и действий
№|Действие|Ресурс
---|---|---
1.|Для запуска проекта необходимо установить Docker-desktop и запустить его|https://www.docker.com/products/docker-desktop/
2.|В микросервисе infra запустить файл run.sh для создания в Docker images на основе файла docker-compose.yaml. После запуска run.sh в Docker создадутся контейнеры, в том числе с Postgres и Redis|https://github.com/StepnovaVarvara/infra
3.|После успешного запуска контейнеров запустить текущий проект|
4.|Протестировать работу проекта можно через swagger ui. Описание вызовов эндпоинтов отражено в swagger, а также в разделе "Команды API" текущего файла|http://localhost:8080/swagger-ui/index.html
5.|Для завершения работы с контейнерами запустить файл stop.sh|https://github.com/StepnovaVarvara/infra

__Компоненты сервиса:__
* URLController - принимает запросы на генерацию нового сокращенного URL, а также для получения оригинальной ссылки из короткой;
* URLService - используется контроллером для генерации коротких URL и их сохранения в БД и Redis, получения оригинальных URL из коротких и проверки их на наличие в Redis и БД;
* HashCache - содержит в себе локальный кэш хэшей для генерации коротких ссылок и логику его асинхронного заполнения;
* HashGenerator - содержит логику генерации хэшей для коротких ссылок из уникальных целых чисел, полученных из БД;
* HashRepository - класс для генерации уникальных целых чисел в БД и получения/сохранения сгенерированных хэшей в БД;
* URLCacheRepository - класс для получения/сохранения популярных ссылок в Redis;
* URLRepository - класс для получения/сохранения ассоциаций коротких и длинных ссылок в БД;
* CleanerScheduler - содержит джобу для удаления устаревших коротких ссылок и перемещения их хэшей обратно в БД.

__Принципы работы:__
1. При старте приложения HashGenerator заполняет локальный кэш - HashCache пачкой хешей для дальнейшей генерации коротких ссылок при запросе, 
а также генерирует и сохраняет в БД очередную пачку хешей;
2. При получении запроса на генерацию сокращенного URL вызывается метод getHash() у HashCache для получения случайного уникального хэша;
3. HashCache при каждом запросе сокращенного URL следить за размером кеша.
При достижении заполненности кеша в 20% от максимальной, асинхронно запускается запрос в БД на получение новой пачки хэшей для кеша, а также доваления новых хешей в БД;
4. После успешной генерации сокращенный URL сохраняется в БД, а также в кеш Redis (на сутки);
5. По джобе запускается CleanerScheduler и находит в БД все URL, которые созданы больше года назад, и удаляет для дальнейшего переиспользования;

__Команды API__
> Запрос: POST  
> Путь: /v1/urls  
> 
> Описание: Генерация сокращенного Url. Метод запускает генерацию сокращенного URL и возвращает его пользователю. Сокращенный URL сохраняется в Redis (на сутки) и БД
> 
> Входные данные: json  
> {  
> "url": "Url-адрес"  
> }  
> 
> Ответ: json  
> {  
> "url": "сокращенный Url"  
> }

__Пример запроса POST:__  
{  
"url": "https://www.baeldung.com/"  
}  

__Пример ответа POST:__  
{  
"url": "http://localhost:8080/Lfg"  
}

> Запрос: GET  
> Путь: /v1/urls/{hash}  
> 
> Описание: Редирект по реферальному URL. Метод принимает хеш проверяет наличие соответсвующего ему URL в Redis и БД, а затем выполняет редирект по реферальному URL
>
> Входные данные: переменная пути /hash, где hash - это путь скоращенного Url после доменного имени
>
> Ответ: редирект по реферальному Url-адресу

__Пример запроса GET:__  
http://localhost:8080/v1/urls/Lfg

### Дополнительные сервисы
infra - сервис, который является инфраструктурной директорией, содержащей в себе описание images (Postgres, Redis, MinIO, Kafka) для создания и запуска контейнеров в Docker (https://github.com/StepnovaVarvara/infra). Контейнеры для MinIO и Kafka не нужны для работы текущего сервиса и создаются для обеспечения работы других сервисов.

